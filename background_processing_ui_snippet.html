<!-- Background Processing Status UI Snippet -->
<!-- Add this to your document viewer templates to show background processing status -->

<div id="background-processing-status" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 16px; min-width: 300px; border-left: 4px solid #10b981;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <div style="width: 20px; height: 20px; border: 2px solid #10b981; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <strong style="color: #1f2937;">Background Processing</strong>
    </div>
    <div id="background-progress-content">
        <div id="background-progress-bar" style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; margin-bottom: 8px;">
            <div id="background-progress-fill" style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div id="background-progress-text" style="font-size: 0.9em; color: #6b7280;">Initializing...</div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.background-success {
    border-left-color: #10b981 !important;
}

.background-processing {
    border-left-color: #3b82f6 !important;
}

.background-error {
    border-left-color: #ef4444 !important;
}
</style>

<script>
// Background Processing UI Controller
class BackgroundProcessingUI {
    constructor() {
        this.statusElement = document.getElementById('background-processing-status');
        this.progressBar = document.getElementById('background-progress-fill');
        this.progressText = document.getElementById('background-progress-text');
        this.isVisible = false;
    }

    show() {
        if (this.statusElement) {
            this.statusElement.style.display = 'block';
            this.isVisible = true;
        }
    }

    hide() {
        if (this.statusElement) {
            this.statusElement.style.display = 'none';
            this.isVisible = false;
        }
    }

    updateProgress(stage, progress, status = {}) {
        if (!this.isVisible) this.show();

        // Update progress bar
        if (this.progressBar) {
            this.progressBar.style.width = `${progress}%`;
        }

        // Update progress text
        if (this.progressText) {
            const stageNames = {
                'ocr_extraction': 'Extracting text from document...',
                'account_splitting': 'Identifying accounts...',
                'page_analysis': 'Analyzing pages...',
                'llm_extraction': 'Extracting data with AI...',
                'completed': 'Processing completed!'
            };

            const stageName = stageNames[stage] || stage;
            const pagesInfo = status.pages_processed && status.total_pages 
                ? ` (${status.pages_processed}/${status.total_pages} pages)`
                : '';
            
            this.progressText.textContent = `${stageName} ${progress}%${pagesInfo}`;
        }

        // Update status styling
        if (this.statusElement) {
            this.statusElement.className = '';
            if (stage === 'completed') {
                this.statusElement.classList.add('background-success');
            } else if (stage === 'failed') {
                this.statusElement.classList.add('background-error');
            } else {
                this.statusElement.classList.add('background-processing');
            }
        }
    }

    showSuccess(message) {
        this.updateProgress('completed', 100);
        if (this.progressText) {
            this.progressText.textContent = message || 'Processing completed successfully!';
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            this.hide();
        }, 5000);
    }

    showError(message) {
        if (!this.isVisible) this.show();
        
        if (this.statusElement) {
            this.statusElement.classList.add('background-error');
        }
        
        if (this.progressText) {
            this.progressText.textContent = message || 'Processing failed';
        }
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            this.hide();
        }, 10000);
    }
}

// Initialize UI controller
window.backgroundProcessingUI = new BackgroundProcessingUI();

// Auto-start monitoring when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get document ID from URL
    const urlPath = window.location.pathname;
    const docMatch = urlPath.match(/\/document\/([^\/]+)/);
    
    if (docMatch && window.backgroundProcessingHelper) {
        const docId = docMatch[1];
        
        // Start monitoring with UI updates
        window.backgroundProcessingHelper.monitorDocument(
            docId,
            (status) => {
                // On completion
                window.backgroundProcessingUI.showSuccess('Document processing completed! Refreshing...');
                
                // Refresh the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            },
            (stage, progress, status) => {
                // On progress
                window.backgroundProcessingUI.updateProgress(stage, progress, status);
            }
        );
    }
});

// Listen for document updates
window.addEventListener('documentUpdated', function(event) {
    const { docId, result } = event.detail;
    console.log('Document updated:', docId, result);
    
    // Show success message
    window.backgroundProcessingUI.showSuccess(`Document updated with ${result.total_accounts || 0} accounts`);
    
    // Refresh document list if function exists
    if (typeof window.loadSkills === 'function') {
        setTimeout(() => {
            window.loadSkills();
        }, 1000);
    }
});
</script>

<!-- Usage Instructions -->
<!-- 
To use this background processing UI:

1. Add this HTML snippet to your document viewer templates
2. Include the background_processing_ui_helper.js file
3. The UI will automatically show when background processing is active
4. Progress updates will be displayed in real-time
5. The page will refresh when processing completes

The UI will show:
- A spinning indicator when processing is active
- Progress bar with percentage
- Current processing stage (OCR, Account Splitting, etc.)
- Page processing progress for LLM extraction
- Success/error states with appropriate colors
- Auto-hide after completion

Customization:
- Modify the CSS styles to match your design
- Change the position by updating the 'top' and 'right' properties
- Customize the stage names in the stageNames object
- Adjust auto-hide timers as needed
-->