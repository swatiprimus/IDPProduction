<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ document.document_name or document.filename }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        
        .back-btn {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }
        
        /* Left Sidebar - Page List (Collapsible) */
        .page-list-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: visible;
            transition: width 0.3s ease;
            position: relative;
            z-index: 100;
        }

        .page-list-sidebar.collapsed {
            width: 0;
            min-width: 0;
            border-right: none;
        }
        
        .sidebar-header {
            padding: 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: visible;
        }
        
        .sidebar-header h2 {
            font-size: 1.2em;
            color: #374151;
            margin-bottom: 5px;
        }

        .toggle-sidebar-btn {
            position: absolute;
            right: -40px;
            top: 20px;
            width: 40px;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s;
            z-index: 101;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .toggle-sidebar-btn:hover {
            background: var(--secondary);
            width: 45px;
        }

        .page-list-sidebar.collapsed .toggle-sidebar-btn {
            right: auto;
            left: 0;
        }
        
        .page-count {
            font-size: 0.9em;
            color: #6b7280;
        }
        
        .pages-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: visible;
            padding: 10px;
        }
        
        .page-item {
            position: relative;
            margin-bottom: 10px;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            background: #f9fafb;
        }
        
        .page-item:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .page-item.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .page-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: contain;
            background: white;
            display: block;
        }
        
        .page-number {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        /* Right Content - Split View */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-width: 0;
            min-height: 0;
        }
        
        /* Document Viewer - 70% */
        .document-viewer-panel {
            flex: 0 0 70%;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e5e7eb;
            min-width: 0;
            min-height: 0;
        }
        
        .viewer-header {
            padding: 12px 20px;
            background: #ffffff;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .doc-filename {
            font-size: 0.95em;
            font-weight: 600;
            color: #374151;
            flex-shrink: 0;
        }
        
        .page-nav {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }
        
        .page-info {
            font-weight: 600;
            color: #374151;
            font-size: 1.1em;
            padding: 0 20px;
            min-width: 150px;
            text-align: center;
        }
        
        .toolbar-btn {
            width: 36px;
            height: 36px;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover:not(:disabled) {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .zoom-display {
            font-size: 0.9em;
            font-weight: 600;
            color: #374151;
            min-width: 50px;
            text-align: center;
        }
        
        .nav-btn {
            width: 36px;
            height: 36px;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .nav-btn:hover:not(:disabled) { 
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .viewer-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: #525659;
            text-align: center;
            min-height: 0;
        }
        
        /* Custom scrollbar for viewer */
        .viewer-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .viewer-content::-webkit-scrollbar-track {
            background: #3f4447;
        }
        
        .viewer-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 5px;
        }
        
        .viewer-content::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        .viewer-content img {
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        /* Data Panel - 30% */
        .data-panel {
            flex: 0 0 30%;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            min-height: 0;
        }
        
        .data-header {
            flex-shrink: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            overflow: visible;
        }
        
        .data-header h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .tab-btn.active {
            background: white;
            color: var(--primary);
        }
        
        .data-meta {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .fields-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .fields-title {
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-badge {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
        }
        
        .field-count {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .search-box::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .search-box:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
        }
        
        .control-section {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            color: rgba(255,255,255,0.9);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-edit {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn-edit:hover { background: rgba(255,255,255,0.3); }
        .btn-edit.active { background: var(--warning); }
        
        .btn-save { background: var(--success); color: white; }
        .btn-cancel { background: #6b7280; color: white; }
        .btn-download { background: #3b82f6; color: white; }
        
        .data-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            min-height: 0;
        }
        
        .data-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .data-content::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        .data-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 5px;
        }
        
        .data-content::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        .field-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            position: relative;
        }
        
        .field-item.delete-mode {
            padding-left: 45px;
        }
        
        .field-checkbox {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--danger);
        }
        
        .field-item.selected-for-delete {
            background: #fee2e2;
            border-left-color: var(--danger);
        }
        
        .field-label {
            font-size: 0.85em;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: capitalize;
        }
        
        .field-value {
            font-size: 1em;
            color: #111827;
            font-weight: 500;
        }
        
        .field-value.editable {
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .field-value.editable:hover { background: #e5e7eb; }
        
        .field-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.error { background: var(--danger); }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/dashboard" class="back-btn">‚Üê {{ document.document_name or document.filename }}</a>
    </div>

    {% if document.needs_review %}
    <div id="reviewBanner" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-bottom: 3px solid #f59e0b; padding: 20px 35px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(245,158,11,0.15);">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="width: 52px; height: 52px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-shrink: 0;">
                ‚ö†Ô∏è
            </div>
            <div>
                <div style="font-weight: 700; color: #92400e; margin-bottom: 6px; font-size: 1.15em; letter-spacing: -0.3px;">
                    Document Updated - Review Required
                </div>
                <div style="font-size: 0.95em; color: #78350f; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <span style="padding: 3px 10px; background: white; border-radius: 12px; font-weight: 600;">
                        {{ document.changes|length }} change(s)
                    </span>
                    {% if document.update_source_filename %}
                    <span>‚Ä¢</span>
                    <span>Source: <strong>{{ document.update_source_filename }}</strong></span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="showChangesModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95em; box-shadow: 0 4px 12px rgba(59,130,246,0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.3)'">
                <span>üìã</span> Review Changes
            </button>
            <button onclick="rejectAllChanges()" style="padding: 12px 24px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95em;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='white'">
                Reject All
            </button>
        </div>
    </div>
    {% endif %}

    <div class="main-container">
        <!-- Left Sidebar: Page List -->
        <div class="page-list-sidebar" id="pageSidebar">
            <div class="sidebar-header">
                <div>
                    <h2>Pages</h2>
                    <div class="page-count" id="pageCount">Loading...</div>
                </div>
            </div>
            <div class="pages-list" id="pagesList">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading pages...</div>
                </div>
            </div>
            <button class="toggle-sidebar-btn" id="toggleSidebarBtn" onclick="toggleSidebar()">
                <span id="toggleIcon">‚óÄ</span>
            </button>
        </div>

        <!-- Right Content: Split View -->
        <div class="content-area">
            <!-- Document Viewer (50%) -->
            <div class="document-viewer-panel">
                <div class="viewer-header">
                    <div class="doc-filename" id="docFilename">{{ document.document_name or document.filename }}</div>
                    <div class="page-nav">
                        <button class="nav-btn" id="prevBtn" onclick="previousPage()" title="Previous Page">‚Üê</button>
                        <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                        <button class="nav-btn" id="nextBtn" onclick="nextPage()" title="Next Page">‚Üí</button>
                        <button class="toolbar-btn" onclick="zoomOut()" title="Zoom Out">üîç-</button>
                        <span class="zoom-display" id="zoomLevel">100%</span>
                        <button class="toolbar-btn" onclick="zoomIn()" title="Zoom In">üîç+</button>
                        <button class="toolbar-btn" onclick="rotateImage()" title="Rotate">üîÑ</button>
                        <button class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
                        <button class="toolbar-btn" onclick="downloadCurrentPage()" title="Download Page">‚¨á</button>
                    </div>
                </div>
                <div class="viewer-content" id="viewerContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Loading document...</div>
                    </div>
                </div>
            </div>

            <!-- Data Panel (50%) -->
            <div class="data-panel">
                <div class="data-header">
                    <h2>Extracted Data</h2>
                    
                    <!-- View Tabs -->
                    <div class="view-tabs">
                        <button class="tab-btn active" id="reviewTab" onclick="switchTab('review')">Review</button>
                        <button class="tab-btn" id="jsonTab" onclick="switchTab('json')">JSON Data</button>
                    </div>
                    
                    <div class="data-meta" id="dataMeta">Select a page to view data</div>
                    
                    <!-- Fields Header with Search -->
                    <div id="fieldsSection" style="display:none;">
                        <div class="fields-header">
                            <div class="fields-title">
                                <span>Extracted Fields</span>
                                <span class="page-badge" id="pageBadge">üìÑ Page 1</span>
                            </div>
                            <div class="field-count" id="fieldCount">0 fields</div>
                        </div>
                        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search fields..." oninput="filterFields()">
                    </div>
                    
                    <!-- Field Actions Section -->
                    <div class="control-section" style="margin-bottom:15px;">
                        <div class="section-title">Field Actions</div>
                        <div class="data-controls">
                            <button class="control-btn" id="addFieldBtnMain" onclick="showAddFieldDialog()" style="display:none;background:#10b981;color:white;">
                                ‚ûï Add
                            </button>
                            <button class="control-btn btn-edit" id="editBtn" onclick="toggleEditMode()" style="display:none;">
                                üìù Edit
                            </button>
                            <button class="control-btn btn-save" id="saveBtn" onclick="savePage()" style="display:none;">
                                ‚úì Save
                            </button>
                            <button class="control-btn btn-cancel" id="cancelBtn" onclick="cancelEdit()" style="display:none;">
                                ‚úï Cancel
                            </button>
                            <button class="control-btn" id="deleteFieldBtn" onclick="toggleDeleteMode()" style="display:none;background:#ef4444;color:white;">
                                üóëÔ∏è Delete
                            </button>
                            <button class="control-btn btn-save" id="confirmDeleteBtn" onclick="confirmDeleteFields()" style="display:none;background:#dc2626;color:white;">
                                ‚úì Confirm
                            </button>
                            <button class="control-btn btn-cancel" id="cancelDeleteBtn" onclick="cancelDeleteMode()" style="display:none;">
                                ‚úï Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Data Actions Section -->
                    <div class="control-section">
                        <div class="section-title">Data Actions</div>
                        <div class="data-controls">
                            <button class="control-btn" id="clearCacheBtn" onclick="clearDocumentCache()" style="display:none;background:#f59e0b;color:white;">
                                üîÑ Refresh
                            </button>
                            <button class="control-btn btn-download" id="downloadPageBtn" onclick="downloadPageJSON()" style="display:none;">
                                üìÑ Page JSON
                            </button>
                            <button class="control-btn btn-download" id="downloadAllBtn" onclick="downloadAllJSON()" style="display:none;">
                                üíæ Complete JSON
                            </button>
                        </div>
                    </div>
                </div>
                <div class="data-content" id="dataContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Select a page to view data</div>
                    </div>
                </div>
                <div class="data-content" id="jsonContent" style="display:none;">
                    <pre id="jsonDisplay" style="background:#1e1e1e;color:#d4d4d4;padding:20px;border-radius:8px;overflow:auto;font-size:0.85em;line-height:1.6;"></pre>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Add Field Modal -->
    <div id="addFieldModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:12px;width:90%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding:20px 30px;background:#f8f9fa;border-bottom:1px solid #e9ecef;border-radius:12px 12px 0 0;">
                <h2 style="margin:0;font-size:1.3em;color:#2c3e50;display:flex;align-items:center;gap:10px;">
                    <span>‚ûï</span>
                    <span>Add New Field</span>
                </h2>
            </div>
            <div style="padding:30px;">
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;color:#495057;">
                        <span style="color:#e74c3c;margin-right:4px;">*</span>Field Name
                    </label>
                    <input type="text" id="newFieldName" placeholder="e.g., Email_Address, Phone_Number" style="width:100%;padding:12px 15px;border:2px solid #e9ecef;border-radius:6px;font-size:1em;">
                    <div style="font-size:0.85em;color:#7f8c8d;margin-top:5px;">Use underscores instead of spaces (e.g., Date_of_Birth)</div>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;color:#495057;">
                        <span style="color:#e74c3c;margin-right:4px;">*</span>Field Value
                    </label>
                    <input type="text" id="newFieldValue" placeholder="Enter the value" style="width:100%;padding:12px 15px;border:2px solid #e9ecef;border-radius:6px;font-size:1em;">
                </div>
            </div>
            <div style="padding:20px 30px;background:#f8f9fa;border-top:1px solid #e9ecef;display:flex;justify-content:flex-end;gap:10px;border-radius:0 0 12px 12px;">
                <button onclick="closeAddFieldDialog()" style="padding:10px 20px;border:1px solid #ddd;background:white;color:#7f8c8d;border-radius:6px;cursor:pointer;font-weight:500;">Cancel</button>
                <button onclick="addNewField()" style="padding:10px 20px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:500;">Add Field</button>
            </div>
        </div>
    </div>

    <script>
        const documentId = '{{ document.id }}';
        let currentPageIndex = 0;
        let totalPages = 0;
        let editMode = false;
        let originalData = {};
        let editedFields = {};
        let currentPageData = null;
        let accounts = [];
        let hasAccounts = false;
        let currentAccountIndex = -1;
        let sidebarCollapsed = false;

        // Toggle sidebar visibility
        function toggleSidebar() {
            const sidebar = document.getElementById('pageSidebar');
            const contentArea = document.querySelector('.content-area');
            const toggleIcon = document.getElementById('toggleIcon');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                contentArea.classList.add('sidebar-collapsed');
                toggleIcon.textContent = '‚ñ∂';
            } else {
                sidebar.classList.remove('collapsed');
                contentArea.classList.remove('sidebar-collapsed');
                toggleIcon.textContent = '‚óÄ';
            }
        }

        // Progressive Page Extraction System
        let extractionProgress = new Map(); // Track extraction progress per page
        let extractionQueue = []; // Queue of pages to extract
        let isExtracting = false; // Flag to prevent concurrent extractions

        // Load pages on page load
        async function loadPages() {
            try {
                // First check if document has accounts
                const docResponse = await fetch(`/api/document/${documentId}`);
                const docData = await docResponse.json();
                
                if (docData.success) {
                    const doc = docData.document.documents[0];
                    accounts = doc.accounts || [];
                    hasAccounts = accounts.length > 0;
                }
                
                const response = await fetch(`/api/document/${documentId}/pages`);
                const data = await response.json();
                
                if (data.success) {
                    totalPages = data.total_pages;
                    document.getElementById('totalPages').textContent = totalPages;
                    
                    if (hasAccounts) {
                        document.getElementById('pageCount').textContent = `${accounts.length} account(s)`;
                        document.querySelector('.sidebar-header h2').textContent = 'Accounts';
                        renderAccountsList();
                        selectAccount(0);
                    } else {
                        document.getElementById('pageCount').textContent = `${totalPages} page(s)`;
                        renderPagesList();
                        showPage(0);
                        
                        // Start progressive extraction for regular documents
                        console.log('üöÄ [PROGRESSIVE] Starting progressive extraction for unified viewer...');
                        startProgressiveExtraction();
                    }
                    
                    // Show controls
                    document.getElementById('editBtn').style.display = 'flex';
                    document.getElementById('downloadPageBtn').style.display = 'flex';
                    document.getElementById('downloadAllBtn').style.display = 'flex';
                    document.getElementById('addFieldBtnMain').style.display = 'flex';
                    document.getElementById('deleteFieldBtn').style.display = 'flex';
                    document.getElementById('clearCacheBtn').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading pages:', error);
                showNotification('Failed to load pages', 'error');
            }
        }

        async function startProgressiveExtraction() {
            console.log('üöÄ [PROGRESSIVE] Starting progressive page extraction for unified viewer...');
            
            // Build extraction queue - only pages that need extraction
            extractionQueue = [];
            
            for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                const progressKey = `${pageIndex}`;
                
                // Check if already extracted in this session
                if (extractionProgress.has(progressKey)) {
                    console.log(`üìã [PROGRESSIVE] Page ${pageIndex + 1} already in progress, skipping`);
                    continue;
                }
                
                // Priority: current page = 1 (highest), next page = 2, others = 3
                let priority = 3;
                if (pageIndex === currentPageIndex) {
                    priority = 1;
                } else if (pageIndex === currentPageIndex + 1) {
                    priority = 2;
                }
                
                extractionQueue.push({
                    pageIndex: pageIndex,
                    priority: priority,
                    progressKey: progressKey
                });
                
                // Mark as queued
                extractionProgress.set(progressKey, {
                    status: 'queued',
                    priority: priority,
                    queuedAt: new Date().toISOString()
                });
            }
            
            // Sort by priority (1 = highest priority)
            extractionQueue.sort((a, b) => a.priority - b.priority);
            
            console.log(`üìã [PROGRESSIVE] Extraction queue built: ${extractionQueue.length} pages to extract`);
            console.log(`üéØ [PROGRESSIVE] Queue contents:`, extractionQueue.map(item => `Page ${item.pageIndex + 1} (Priority ${item.priority})`));
            
            if (extractionQueue.length === 0) {
                console.log('‚úÖ [PROGRESSIVE] No pages queued for extraction');
                return;
            }
            
            // Start processing queue
            processExtractionQueue();
        }

        async function processExtractionQueue() {
            if (isExtracting || extractionQueue.length === 0) {
                return;
            }
            
            isExtracting = true;
            console.log(`‚ö° [PROGRESSIVE] Processing extraction queue (${extractionQueue.length} items remaining)`);
            
            // Process items in parallel (up to 3 at a time for performance)
            const maxConcurrent = 3;
            const promises = [];
            
            for (let i = 0; i < Math.min(maxConcurrent, extractionQueue.length); i++) {
                const item = extractionQueue.shift();
                if (item) {
                    promises.push(extractSinglePageAsync(item, item.progressKey));
                }
            }
            
            // Wait for all current extractions to complete
            await Promise.allSettled(promises);
            
            isExtracting = false;
            
            // Continue processing if there are more items
            if (extractionQueue.length > 0) {
                setTimeout(() => processExtractionQueue(), 100);
            } else {
                console.log('‚úÖ [PROGRESSIVE] All pages extracted!');
            }
        }

        async function extractSinglePageAsync(item, key) {
            try {
                console.log(`üöÄ [PROGRESSIVE] Starting extraction for page ${item.pageIndex + 1}...`);
                
                // OPTIMIZATION: Check cache first before extracting
                try {
                    console.log(`üîç [PROGRESSIVE] Quick cache check for page ${item.pageIndex + 1}...`);
                    const cacheResponse = await fetch(`/api/document/${documentId}/page/${item.pageIndex + 1}/extract`);
                    const cacheResult = await cacheResponse.json();
                    
                    if (cacheResult.success && cacheResult.cached) {
                        console.log(`‚úÖ [PROGRESSIVE] Page ${item.pageIndex + 1} found in cache, skipping extraction`);
                        extractionProgress.set(key, {
                            status: 'completed',
                            cached: true,
                            completedAt: new Date().toISOString()
                        });
                        return; // Skip extraction
                    }
                } catch (cacheError) {
                    console.log(`‚ö†Ô∏è [PROGRESSIVE] Cache check failed, proceeding with extraction: ${cacheError.message}`);
                }
                
                // Mark as extracting
                extractionProgress.set(key, {
                    status: 'extracting',
                    priority: item.priority,
                    startedAt: new Date().toISOString()
                });
                
                // Call the page extraction API
                const response = await fetch(`/api/document/${documentId}/page/${item.pageIndex}/extract-progressive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        priority: item.priority
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ [PROGRESSIVE] Page ${item.pageIndex + 1} extracted successfully (${result.fieldsExtracted} fields)`);
                    
                    // Mark as completed
                    extractionProgress.set(key, {
                        status: 'completed',
                        priority: item.priority,
                        completedAt: new Date().toISOString(),
                        fieldsExtracted: result.fieldsExtracted,
                        extractionTime: result.extractionTime
                    });
                    
                    // Update UI if this is the current page
                    if (item.pageIndex === currentPageIndex) {
                        console.log(`üîÑ [PROGRESSIVE] Refreshing current page ${item.pageIndex + 1} with new data`);
                        renderPageData();
                    }
                    
                } else {
                    console.error(`‚ùå [PROGRESSIVE] Page ${item.pageIndex + 1} extraction failed:`, result.message);
                    
                    // Mark as failed
                    extractionProgress.set(key, {
                        status: 'failed',
                        priority: item.priority,
                        failedAt: new Date().toISOString(),
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error(`‚ùå [PROGRESSIVE] Page ${item.pageIndex + 1} extraction error:`, error);
                
                // Mark as failed
                extractionProgress.set(key, {
                    status: 'failed',
                    priority: item.priority,
                    failedAt: new Date().toISOString(),
                    error: error.message
                });
            }
        }

        // Wait for progressive extraction to complete for a specific page
        async function waitForProgressiveExtraction(progressKey) {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    const progress = extractionProgress.get(progressKey);
                    if (progress && (progress.status === 'completed' || progress.status === 'failed')) {
                        clearInterval(checkInterval);
                        resolve(progress);
                    }
                }, 500); // Check every 500ms
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve({ status: 'timeout' });
                }, 30000);
            });
        }

        function renderAccountsList() {
            const container = document.getElementById('pagesList');
            let html = '';
            
            accounts.forEach((account, index) => {
                html += `
                    <div class="page-item ${index === 0 ? 'active' : ''}" onclick="selectAccount(${index})" id="account-${index}">
                        <div class="page-number">Account: ${account.accountNumber}</div>
                        <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">
                            ${account.accuracy_score}% | ${account.filled_fields}/${account.total_fields} fields
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectAccount(index) {
            if (editMode) exitEditMode();
            
            currentAccountIndex = index;
            currentPageIndex = 0;
            
            document.querySelectorAll('.page-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            loadAccountPages();
        }

        async function loadAccountPages() {
            try {
                const response = await fetch(`/api/document/${documentId}/account/${currentAccountIndex}/pages`);
                const data = await response.json();
                
                if (data.success) {
                    totalPages = data.total_pages;
                    document.getElementById('totalPages').textContent = totalPages;
                    showPage(0);
                }
            } catch (error) {
                console.error('Error loading account pages:', error);
            }
        }

        function renderPagesList() {
            const container = document.getElementById('pagesList');
            let html = '';
            
            for (let i = 0; i < totalPages; i++) {
                const thumbnailUrl = hasAccounts && currentAccountIndex >= 0
                    ? `/api/document/${documentId}/account/${currentAccountIndex}/page/${i}`
                    : `/api/document/${documentId}/page/${i + 1}/image`;
                
                html += `
                    <div class="page-item ${i === 0 ? 'active' : ''}" onclick="selectPage(${i})" id="page-${i}">
                        <img src="${thumbnailUrl}" alt="Page ${i + 1}" class="page-thumbnail" loading="lazy" onerror="console.error('‚ùå Thumbnail failed to load:', this.src)">
                        <div class="page-number">${i + 1}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function selectPage(index) {
            // Exit edit mode if active
            if (editMode) {
                exitEditMode();
            }
            
            // Update active state
            document.querySelectorAll('.page-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            showPage(index);
        }

        function showPage(pageIndex) {
            if (pageIndex < 0 || pageIndex >= totalPages) return;
            
            // Exit edit mode if active
            if (editMode) {
                exitEditMode();
            }
            
            currentPageIndex = pageIndex;
            document.getElementById('currentPage').textContent = pageIndex + 1;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = pageIndex === 0;
            document.getElementById('nextBtn').disabled = pageIndex === totalPages - 1;
            
            // Update active page in sidebar
            document.querySelectorAll('.page-item').forEach((item, i) => {
                item.classList.toggle('active', i === pageIndex);
            });
            
            // Load page image
            const viewer = document.getElementById('viewerContent');
            if (hasAccounts && currentAccountIndex >= 0) {
                const imageUrl = `/api/document/${documentId}/account/${currentAccountIndex}/page/${pageIndex}`;
                console.log(`[IMAGE] Loading account page image: ${imageUrl}`);
                viewer.innerHTML = `<img src="${imageUrl}" alt="Page ${pageIndex + 1}" onload="console.log('‚úÖ Image loaded successfully')" onerror="console.error('‚ùå Image failed to load:', this.src)">`;
            } else {
                // Use 1-based page numbers for the API and include /image endpoint
                const imageUrl = `/api/document/${documentId}/page/${pageIndex + 1}/image`;
                console.log(`[IMAGE] Loading regular page image: ${imageUrl}`);
                viewer.innerHTML = `<img src="${imageUrl}" alt="Page ${pageIndex + 1}" onload="console.log('‚úÖ Image loaded successfully')" onerror="console.error('‚ùå Image failed to load:', this.src)">`;
            }
            
            // Reset zoom and rotation
            resetViewerTransform();
            
            // Load page data
            renderPageData();
        }

        async function renderPageData() {
            const container = document.getElementById('dataContent');
            
            const metaText = hasAccounts && currentAccountIndex >= 0 
                ? `Account ${accounts[currentAccountIndex].accountNumber} - Page ${currentPageIndex + 1} - Loading...`
                : `Page ${currentPageIndex + 1} - Loading...`;
            document.getElementById('dataMeta').textContent = metaText;
            container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Extracting data from page...</div></div>';
            
            try {
                let response, result;
                if (hasAccounts && currentAccountIndex >= 0) {
                    response = await fetch(`/api/document/${documentId}/account/${currentAccountIndex}/page/${currentPageIndex}/data`);
                } else {
                    // Fix: Use 1-based page numbers for the API (currentPageIndex is 0-based)
                    response = await fetch(`/api/document/${documentId}/page/${currentPageIndex + 1}/extract`);
                }
                result = await response.json();
                
                if (result.success) {
                    let fields = result.extracted_fields || result.data || {};
                    
                    // STEP 1: Process confidence objects recursively - keep both value and confidence for inline display
                    const processedFields = {};
                    const fieldConfidence = {}; // Store confidence scores separately
                    
                    function processConfidenceRecursive(obj, prefix = '') {
                        const processed = {};
                        for (const [key, value] of Object.entries(obj)) {
                            const fullKey = prefix ? `${prefix}_${key}` : key;
                            
                            if (value && typeof value === 'object' && !Array.isArray(value)) {
                                // Check if this is a confidence object (can have 2 or 3 keys: value, confidence, source)
                                if ('value' in value && 'confidence' in value) {
                                    // This is a confidence object
                                    processed[key] = value.value;
                                    fieldConfidence[fullKey] = value.confidence;
                                    console.log(`‚úì Processed confidence object: ${fullKey} = ${value.value} (${value.confidence}% confidence)`);
                                } else {
                                    // Recursively process nested objects
                                    processed[key] = processConfidenceRecursive(value, fullKey);
                                }
                            } else {
                                processed[key] = value;
                            }
                        }
                        return processed;
                    }
                    
                    fields = processConfidenceRecursive(fields);
                    
                    currentPageData = fields;
                    let html = '';
                    let seenFields = new Set(); // Track fields to avoid duplicates
                    
                    // Calculate accuracy
                    let totalFields = 0;
                    let filledFields = 0;
                    
                    // First, log all fields to debug
                    console.log('All fields received:', fields);
                    console.log('Number of fields:', Object.keys(fields).length);
                    
                    // Flatten nested objects into a single level
                    function flattenObject(obj, prefix = '') {
                        let flattened = {};
                        for (const [key, value] of Object.entries(obj)) {
                            const newKey = prefix ? `${prefix}_${key}` : key;
                            
                            if (value && typeof value === 'object' && !Array.isArray(value)) {
                                // CRITICAL: Check if this is a confidence object {value: "X", confidence: 95, source: "human"}
                                if ('value' in value && 'confidence' in value) {
                                    // This is a confidence object - keep it as-is, don't flatten
                                    flattened[newKey] = value;
                                    console.log(`‚úì Preserved confidence object in flattening: ${newKey}`);
                                } else {
                                    // Recursively flatten other nested objects
                                    Object.assign(flattened, flattenObject(value, newKey));
                                }
                            } else {
                                flattened[newKey] = value;
                            }
                        }
                        return flattened;
                    }
                    
                    const flattenedFields = flattenObject(fields);
                    console.log('Flattened fields:', flattenedFields);
                    console.log('Total flattened fields:', Object.keys(flattenedFields).length);
                    
                    for (const [key, value] of Object.entries(flattenedFields)) {
                        totalFields++;
                        const displayValue = Array.isArray(value) ? value.join(', ') : value;
                        if (displayValue && displayValue !== 'N/A' && displayValue.toString().trim() !== '') {
                            filledFields++;
                        }
                    }
                    
                    // Calculate average confidence score for this page
                    const confidenceScores = Object.values(fieldConfidence);
                    const avgConfidence = confidenceScores.length > 0 
                        ? Math.round(confidenceScores.reduce((sum, conf) => sum + conf, 0) / confidenceScores.length)
                        : 0;
                    const confidenceColor = avgConfidence >= 90 ? '#10b981' : avgConfidence >= 70 ? '#f59e0b' : '#ef4444';
                    
                    document.getElementById('dataMeta').innerHTML = `
                        Page ${currentPageIndex + 1}
                        <span style="display:inline-block;margin-left:10px;padding:4px 8px;background:${confidenceColor};color:white;border-radius:4px;font-size:0.85em;font-weight:600;">
                            ${avgConfidence}% Confidence (${filledFields} fields)
                        </span>
                    `;
                    
                    // Group signer fields
                    const signerGroups = {};
                    const regularFields = {};
                    
                    for (const [key, value] of Object.entries(flattenedFields)) {
                        // Skip duplicates (case-insensitive)
                        const normalizedKey = key.toLowerCase().replace(/[_\s]/g, '');
                        if (seenFields.has(normalizedKey)) {
                            console.log(`Skipping duplicate field: ${key}`);
                            continue;
                        }
                        seenFields.add(normalizedKey);
                        
                        // Check if this is a confidence object that needs processing
                        let actualValue = value;
                        if (value && typeof value === 'object' && !Array.isArray(value) && 'value' in value && 'confidence' in value) {
                            actualValue = value.value;
                            fieldConfidence[key] = value.confidence;
                            console.log(`‚úì Post-flatten confidence object: ${key} = ${actualValue} (${value.confidence}% confidence)`);
                        }
                        
                        // Format display value based on type
                        let displayValue;
                        if (Array.isArray(actualValue)) {
                            // Check if array contains objects
                            if (actualValue.length > 0 && typeof actualValue[0] === 'object') {
                                // Format array of objects as JSON
                                displayValue = JSON.stringify(actualValue, null, 2);
                            } else {
                                // Join primitive values
                                displayValue = actualValue.join(', ');
                            }
                        } else if (typeof actualValue === 'object' && actualValue !== null) {
                            // Format objects as JSON
                            displayValue = JSON.stringify(actualValue, null, 2);
                        } else {
                            displayValue = actualValue;
                        }
                        
                        // Skip N/A fields
                        if (!displayValue || displayValue === 'N/A' || displayValue.toString().trim() === '') {
                            console.log(`Skipping empty/N/A field: ${key} = ${displayValue}`);
                            continue;
                        }
                        
                        // Check if this is a signer field: Signer1_Name, Signer1 Name, Signer2_Address, etc.
                        // Match both underscore and space separators
                        const signerMatch = key.match(/^Signer(\d+)[\s_](.+)$/i);
                        if (signerMatch) {
                            const signerNum = parseInt(signerMatch[1]);
                            const fieldName = signerMatch[2];
                            console.log(`‚úì Matched signer field: ${key} -> Signer ${signerNum}, Field: ${fieldName}`);
                            if (!signerGroups[signerNum]) {
                                signerGroups[signerNum] = {};
                            }
                            signerGroups[signerNum][fieldName] = displayValue;
                        } else {
                            regularFields[key] = displayValue;
                        }
                    }
                    
                    // Helper function to escape HTML
                    function escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }
                    
                    // Display regular fields first
                    for (const [key, displayValue] of Object.entries(regularFields)) {
                        console.log(`Displaying field: ${key} = ${displayValue}`);
                        
                        // Special handling for SupportingDocuments
                        if (key === 'SupportingDocuments' || key === 'Supporting_Documents') {
                            let docsArray = displayValue;
                            
                            // Parse if it's a JSON string
                            if (typeof displayValue === 'string') {
                                try {
                                    docsArray = JSON.parse(displayValue);
                                } catch (e) {
                                    console.error('Failed to parse SupportingDocuments:', e);
                                }
                            }
                            
                            if (Array.isArray(docsArray) && docsArray.length > 0) {
                                const docId = `supporting-docs-${Date.now()}`;
                                html += `
                                    <div class="field-item" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-left-color:#0ea5e9;cursor:pointer;" onclick="toggleSupportingDocs('${docId}')">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <div class="field-label" style="color:#0369a1;font-weight:700;">üìé Supporting Documents (${docsArray.length})</div>
                                            <span id="${docId}-icon" style="color:#0369a1;font-size:1.2em;font-weight:bold;transition:transform 0.3s;">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div id="${docId}" style="max-height:0;overflow:hidden;transition:max-height 0.4s ease;">
                                        <div style="padding:10px 20px;background:#f8fafc;">
                                `;
                                
                                docsArray.forEach((doc, idx) => {
                                    const docType = doc.DocumentType || doc.Type || 'Document';
                                    const details = doc.Details || doc.details || 'No details';
                                    html += `
                                        <div style="margin-bottom:12px;padding:12px;background:white;border-left:3px solid #0ea5e9;border-radius:6px;">
                                            <div style="font-weight:700;color:#0369a1;margin-bottom:4px;">üìÑ ${docType}</div>
                                            <div style="color:#475569;font-size:0.95em;">${escapeHtml(details)}</div>
                                        </div>
                                    `;
                                });
                                
                                html += `
                                        </div>
                                    </div>
                                `;
                            }
                            continue;
                        }
                        
                        // Prepare confidence badge with color and source indicator
                        let confidenceBadge = '';
                        
                        // Check if this field has a source indicator
                        const fieldData = flattenedFields[key];
                        const isHumanVerified = fieldData && typeof fieldData === 'object' && fieldData.source === 'human';
                        
                        if (isHumanVerified) {
                            // Human-verified fields get a special badge
                            confidenceBadge = ` <span style="color:#10b981;font-size:0.85em;font-weight:700;background:#d1fae5;padding:2px 6px;border-radius:4px;">‚úì 100% (Human Verified)</span>`;
                        } else if (fieldConfidence[key]) {
                            const conf = fieldConfidence[key];
                            let confColor = '#6b7280'; // Default gray
                            
                            // Set color based on confidence
                            if (conf >= 90) {
                                confColor = '#10b981'; // Green
                            } else if (conf >= 70) {
                                confColor = '#f59e0b'; // Orange/Yellow
                            } else {
                                confColor = '#ef4444'; // Red
                            }
                            
                            // Add confidence percentage badge with color
                            confidenceBadge = ` <span style="color:${confColor};font-size:0.85em;font-weight:700;">(${conf}%)</span>`;
                        }
                        
                        // Check if displayValue is JSON (starts with { or [)
                        const isJson = typeof displayValue === 'string' && (displayValue.trim().startsWith('{') || displayValue.trim().startsWith('['));
                        const fontFamily = isJson ? 'monospace' : 'inherit';
                        const whiteSpace = isJson ? 'pre-wrap' : 'normal';
                        
                        // Escape HTML to preserve formatting
                        const escapedValue = escapeHtml(displayValue.toString());
                        
                        html += `
                            <div class="field-item">
                                <div class="field-label">${key.replace(/_/g, ' ')}</div>
                                <div class="field-value" data-field="${key}" style="font-family:${fontFamily};white-space:${whiteSpace};">${escapedValue}${confidenceBadge}</div>
                            </div>
                        `;
                    }
                    
                    // Display grouped signers with clean design
                    const signerNumbers = Object.keys(signerGroups).sort((a, b) => a - b);
                    if (signerNumbers.length > 0) {
                        console.log(`Found ${signerNumbers.length} signers to display`);
                        
                        // Display each signer with clean card design
                        signerNumbers.forEach(signerNum => {
                            const signer = signerGroups[signerNum];
                            const fieldCount = Object.keys(signer).length;
                            const signerId = `signer-${signerNum}-${Date.now()}`;
                            
                            // Build signer fields HTML
                            let signerFieldsHtml = '';
                            for (const [fieldName, fieldValue] of Object.entries(signer)) {
                                const signerFieldKey = `Signer${signerNum}_${fieldName}`;
                                let confidenceBadge = '';
                                
                                if (fieldConfidence[signerFieldKey]) {
                                    const conf = fieldConfidence[signerFieldKey];
                                    let confColor = conf >= 90 ? '#10b981' : conf >= 70 ? '#f59e0b' : '#ef4444';
                                    confidenceBadge = ` <span style="color:${confColor};font-size:0.85em;font-weight:700;">(${conf}%)</span>`;
                                }
                                
                                const isJson = typeof fieldValue === 'string' && (fieldValue.trim().startsWith('{') || fieldValue.trim().startsWith('['));
                                const escapedValue = escapeHtml(fieldValue.toString());
                                
                                signerFieldsHtml += `
                                    <div style="margin-bottom:12px;padding:12px;background:white;border-left:3px solid #667eea;border-radius:6px;">
                                        <div style="font-weight:700;color:#667eea;margin-bottom:4px;font-size:0.85em;">${fieldName.replace(/_/g, ' ')}</div>
                                        <div style="color:#1e293b;font-size:0.95em;font-family:${isJson ? 'monospace' : 'inherit'};white-space:${isJson ? 'pre-wrap' : 'normal'};">${escapedValue}${confidenceBadge}</div>
                                    </div>
                                `;
                            }
                            
                            // Signer card with expand/collapse
                            html += `
                                <div class="field-item" style="background:linear-gradient(135deg, #f0f4ff 0%, #e5edff 100%);border-left-color:#667eea;cursor:pointer;margin-top:15px;" onclick="toggleSignerSection('${signerId}')">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div class="field-label" style="color:#4338ca;font-weight:700;">üë§ Signer ${signerNum} (${fieldCount} fields)</div>
                                        <span id="${signerId}-icon" style="color:#4338ca;font-size:1.2em;font-weight:bold;transition:transform 0.3s;">‚ñ∂</span>
                                    </div>
                                </div>
                                <div id="${signerId}" style="max-height:0;overflow:hidden;transition:max-height 0.4s ease;">
                                    <div style="padding:10px 20px;background:#f8fafc;">
                                        ${signerFieldsHtml}
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    container.innerHTML = html || '<div class="loading">No data extracted from this page</div>';
                    
                    // Update fields section
                    document.getElementById('fieldsSection').style.display = 'block';
                    document.getElementById('pageBadge').textContent = `üìÑ Page ${currentPageIndex + 1}`;
                    document.getElementById('fieldCount').textContent = `${totalFields} fields`;
                    document.getElementById('searchBox').value = ''; // Reset search
                    
                    // Update JSON view
                    if (currentView === 'json') {
                        document.getElementById('jsonDisplay').innerHTML = formatJsonWithConfidence(fields);
                    }
                } else {
                    currentPageData = null;
                    document.getElementById('fieldsSection').style.display = 'none';
                    container.innerHTML = `<div class="loading">Error: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading page data:', error);
                container.innerHTML = `<div class="loading">Failed to load page data: ${error.message}</div>`;
            }
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                showPage(currentPageIndex - 1);
            }
        }

        function nextPage() {
            if (currentPageIndex < totalPages - 1) {
                showPage(currentPageIndex + 1);
            }
        }
        
        function toggleSignerSection(signerId) {
            const container = document.getElementById(signerId);
            const icon = document.getElementById(`${signerId}-icon`);
            
            if (!container || !icon) return;
            
            const isExpanded = container.style.maxHeight && container.style.maxHeight !== '0px';
            
            if (isExpanded) {
                // Collapse
                container.style.maxHeight = '0';
                icon.textContent = '‚ñ∂';
            } else {
                // Expand
                container.style.maxHeight = '2000px';
                icon.textContent = '‚ñº';
            }
        }
        
        function toggleSupportingDocs(docId) {
            const container = document.getElementById(docId);
            const icon = document.getElementById(`${docId}-icon`);
            
            if (!container || !icon) return;
            
            const isExpanded = container.style.maxHeight && container.style.maxHeight !== '0px';
            
            if (isExpanded) {
                // Collapse
                container.style.maxHeight = '0';
                icon.textContent = '‚ñ∂';
            } else {
                // Expand
                container.style.maxHeight = '1000px';
                icon.textContent = '‚ñº';
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (editMode) {
                editBtn.classList.add('active');
                editBtn.textContent = 'üìù Editing...';
                saveBtn.style.display = 'flex';
                cancelBtn.style.display = 'flex';
                
                document.querySelectorAll('.field-value').forEach(field => {
                    field.classList.add('editable');
                    field.onclick = () => makeFieldEditable(field);
                    originalData[field.dataset.field] = field.textContent;
                });
                
                showNotification('Edit mode activated - Click fields to edit or add new fields', 'success');
            } else {
                exitEditMode();
            }
        }

        function exitEditMode() {
            editMode = false;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            editBtn.classList.remove('active');
            editBtn.textContent = 'üìù Edit Page';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            document.querySelectorAll('.field-value').forEach(field => {
                field.classList.remove('editable');
                field.onclick = null;
            });
            
            editedFields = {};
            originalData = {};
        }

        function makeFieldEditable(element) {
            if (!editMode) return;
            
            const fieldName = element.dataset.field;
            
            // Get the actual value from currentPageData, not from the displayed text (which includes confidence badge)
            let actualValue = '';
            if (currentPageData && currentPageData[fieldName]) {
                const fieldData = currentPageData[fieldName];
                // Handle both old format (string) and new format (object with value/confidence)
                if (typeof fieldData === 'object' && fieldData.value !== undefined) {
                    actualValue = fieldData.value;
                } else {
                    actualValue = fieldData;
                }
            }
            
            // Store original value for cancel
            if (!element.dataset.originalValue) {
                element.dataset.originalValue = actualValue;
            }
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'field-input';
            input.value = actualValue === 'N/A' ? '' : actualValue;
            
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            
            input.oninput = () => {
                editedFields[fieldName] = input.value.trim();
            };
            
            input.onblur = () => {
                // If value changed, keep the new value; otherwise restore original
                const newValue = input.value.trim();
                if (newValue) {
                    element.textContent = newValue;
                } else {
                    // Restore original value from dataset
                    element.textContent = element.dataset.originalValue || 'N/A';
                }
            };
        }

        async function savePage() {
            if (Object.keys(editedFields).length === 0) {
                showNotification('No changes to save', 'error');
                return;
            }
            
            try {
                // Prepare the data to save - preserve existing field formats
                const dataToSave = {};
                
                // Copy all existing fields as-is (preserving their confidence scores)
                for (const [key, value] of Object.entries(currentPageData)) {
                    dataToSave[key] = value;
                }
                
                // Update only the edited fields with human-verified format
                for (const [fieldName, fieldValue] of Object.entries(editedFields)) {
                    // Human-edited fields get 100% confidence and a source flag
                    dataToSave[fieldName] = {
                        value: fieldValue,
                        confidence: 100,
                        source: 'human'
                    };
                }
                
                // Update currentPageData
                currentPageData = dataToSave;
                
                // Save to backend and update S3 cache (Fix: Use 1-based page numbers)
                const response = await fetch(`/api/document/${documentId}/page/${currentPageIndex + 1}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_data: dataToSave
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                showNotification('Page saved successfully! Changes will persist.', 'success');
                exitEditMode();
                renderPageData();
            } catch (error) {
                showNotification('Failed to save: ' + error.message, 'error');
            }
        }

        function cancelEdit() {
            if (Object.keys(editedFields).length > 0) {
                if (confirm('Discard changes?')) {
                    editedFields = {}; // Clear edited fields
                    renderPageData(); // Re-render to restore original values
                    exitEditMode();
                }
            } else {
                exitEditMode();
            }
        }

        function showAddFieldDialog() {
            const modal = document.getElementById('addFieldModal');
            modal.style.display = 'flex';
            document.getElementById('newFieldName').value = '';
            document.getElementById('newFieldValue').value = '';
            document.getElementById('newFieldName').focus();
            
            // Add keyboard support
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    addNewField();
                } else if (e.key === 'Escape') {
                    closeAddFieldDialog();
                }
            };
            
            document.getElementById('newFieldName').onkeydown = handleKeyPress;
            document.getElementById('newFieldValue').onkeydown = handleKeyPress;
        }

        function closeAddFieldDialog() {
            document.getElementById('addFieldModal').style.display = 'none';
        }

        async function addNewField() {
            const fieldName = document.getElementById('newFieldName').value.trim();
            const fieldValue = document.getElementById('newFieldValue').value.trim();
            
            if (!fieldName) {
                showNotification('Please enter a field name', 'error');
                return;
            }
            
            if (!fieldValue) {
                showNotification('Please enter a field value', 'error');
                return;
            }
            
            // Check if field already exists
            if (currentPageData && currentPageData[fieldName]) {
                if (!confirm(`Field "${fieldName}" already exists. Do you want to overwrite it?`)) {
                    return;
                }
            }
            
            try {
                // Add to current page data
                if (!currentPageData) {
                    currentPageData = {};
                }
                
                // Prepare the data to save - preserve existing field formats
                const dataToSave = {};
                
                // Copy all existing fields as-is (preserving their confidence scores)
                for (const [key, value] of Object.entries(currentPageData)) {
                    dataToSave[key] = value;
                }
                
                // Add the new field with human-verified format
                dataToSave[fieldName] = {
                    value: fieldValue,
                    confidence: 100,
                    source: 'human'
                };
                
                // Update currentPageData
                currentPageData = dataToSave;
                
                // Save to backend and update S3 cache (Fix: Use 1-based page numbers)
                const response = await fetch(`/api/document/${documentId}/page/${currentPageIndex + 1}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_data: dataToSave
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                showNotification(`Field "${fieldName}" added successfully!`, 'success');
                closeAddFieldDialog();
                renderPageData();
            } catch (error) {
                showNotification('Failed to add field: ' + error.message, 'error');
            }
        }

        function downloadPageJSON() {
            if (!currentPageData) {
                showNotification('No page data available', 'error');
                return;
            }
            
            const pageData = {
                page_number: currentPageIndex + 1,
                data: currentPageData
            };
            
            const blob = new Blob([JSON.stringify(pageData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `page_${currentPageIndex + 1}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Page JSON downloaded!', 'success');
        }

        async function downloadAllJSON() {
            showNotification('Collecting data from all pages...', 'success');
            
            const allPagesData = [];
            for (let i = 0; i < totalPages; i++) {
                try {
                    const response = await fetch(`/api/document/${documentId}/page/${i + 1}/extract`);
                    const result = await response.json();
                    
                    if (result.success) {
                        allPagesData.push({
                            page_number: i + 1,
                            data: result.extracted_fields || result.data
                        });
                    }
                } catch (error) {
                    console.error(`Failed to get data for page ${i + 1}:`, error);
                }
            }
            
            const completeData = {
                document_name: '{{ document.document_name or document.filename }}',
                total_pages: totalPages,
                pages: allPagesData
            };
            
            const blob = new Blob([JSON.stringify(completeData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'complete_document.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Complete JSON downloaded!', 'success');
        }

        async function clearDocumentCache() {
            if (!confirm('Clear cache and re-extract all pages with updated prompts?\n\nThis will:\n- Delete all cached page data\n- Force fresh extraction on next page click\n- Extract stamp dates and other new fields')) {
                return;
            }
            
            try {
                showNotification('Clearing cache...', 'success');
                
                const response = await fetch(`/api/document/${documentId}/clear-cache`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    
                    // Reload current page to get fresh data
                    setTimeout(() => {
                        showPage(currentPageIndex);
                    }, 2000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Failed to clear cache: ${error.message}`, 'error');
            }
        }

        // Delete mode functionality
        let deleteMode = false;
        let selectedFieldsForDelete = new Set();
        
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            selectedFieldsForDelete.clear();
            
            const deleteBtn = document.getElementById('deleteFieldBtn');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            const addBtn = document.getElementById('addFieldBtnMain');
            const editBtn = document.getElementById('editBtn');
            
            if (deleteMode) {
                // Enter delete mode
                deleteBtn.style.display = 'none';
                confirmBtn.style.display = 'flex';
                cancelBtn.style.display = 'flex';
                addBtn.style.display = 'none';
                editBtn.style.display = 'none';
                
                // Add checkboxes to all field items
                document.querySelectorAll('.field-item').forEach(item => {
                    const fieldValue = item.querySelector('.field-value');
                    if (fieldValue && fieldValue.dataset.field) {
                        item.classList.add('delete-mode');
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'field-checkbox';
                        checkbox.dataset.field = fieldValue.dataset.field;
                        checkbox.onchange = (e) => {
                            if (e.target.checked) {
                                selectedFieldsForDelete.add(e.target.dataset.field);
                                item.classList.add('selected-for-delete');
                            } else {
                                selectedFieldsForDelete.delete(e.target.dataset.field);
                                item.classList.remove('selected-for-delete');
                            }
                        };
                        
                        item.insertBefore(checkbox, item.firstChild);
                    }
                });
                
                showNotification('Select fields to delete', 'success');
            } else {
                cancelDeleteMode();
            }
        }
        
        function cancelDeleteMode() {
            deleteMode = false;
            selectedFieldsForDelete.clear();
            
            const deleteBtn = document.getElementById('deleteFieldBtn');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            const addBtn = document.getElementById('addFieldBtnMain');
            const editBtn = document.getElementById('editBtn');
            
            deleteBtn.style.display = 'flex';
            confirmBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            addBtn.style.display = 'flex';
            editBtn.style.display = 'flex';
            
            // Remove checkboxes and classes
            document.querySelectorAll('.field-checkbox').forEach(cb => cb.remove());
            document.querySelectorAll('.field-item').forEach(item => {
                item.classList.remove('delete-mode', 'selected-for-delete');
            });
        }
        
        async function confirmDeleteFields() {
            if (selectedFieldsForDelete.size === 0) {
                showNotification('No fields selected', 'error');
                return;
            }
            
            const count = selectedFieldsForDelete.size;
            if (!confirm(`Delete ${count} selected field${count > 1 ? 's' : ''}?`)) {
                return;
            }
            
            try {
                // Remove selected fields from currentPageData
                selectedFieldsForDelete.forEach(fieldName => {
                    delete currentPageData[fieldName];
                });
                
                // Save updated data to backend (Fix: Use 1-based page numbers)
                const response = await fetch(`/api/document/${documentId}/page/${currentPageIndex + 1}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_data: currentPageData
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                showNotification(`${count} field${count > 1 ? 's' : ''} deleted successfully!`, 'success');
                cancelDeleteMode();
                
                // Reload the page to show updated data
                setTimeout(() => {
                    renderPageData();
                }, 300);
                
            } catch (error) {
                showNotification('Failed to delete fields: ' + error.message, 'error');
            }
        }

        async function markAsReviewed() {
            try {
                const response = await fetch(`/api/document/${documentId}/mark-reviewed`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Document marked as reviewed', 'success');
                    // Reload page to remove banner
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification('Failed to mark as reviewed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error marking as reviewed:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // View mode
        let currentView = 'review'; // 'review' or 'json'
        
        // Zoom functionality
        let currentZoom = 100;
        let currentRotation = 0;
        
        function formatJsonWithConfidence(data) {
            // Format JSON with syntax highlighting and colored confidence scores
            let json = JSON.stringify(data, null, 2);
            
            // Syntax highlighting
            json = json.replace(/(".*?"):/g, '<span style="color:#9cdcfe;">$1</span>:');
            json = json.replace(/: (".*?")/g, ': <span style="color:#ce9178;">$1</span>');
            json = json.replace(/: (\d+\.?\d*)/g, function(match, num) {
                // Check if this is a confidence score (look for "confidence": pattern before it)
                return ': <span style="color:#b5cea8;">' + num + '</span>';
            });
            json = json.replace(/: (true|false|null)/g, ': <span style="color:#569cd6;">$1</span>');
            
            // Highlight confidence scores with colors
            json = json.replace(/"confidence":\s*<span style="color:#b5cea8;">(\d+)<\/span>/g, function(match, conf) {
                const confNum = parseInt(conf);
                let color = '#6b7280';
                if (confNum >= 90) color = '#10b981';
                else if (confNum >= 70) color = '#f59e0b';
                else color = '#ef4444';
                return `"confidence": <span style="color:${color};font-weight:700;">${conf}</span>`;
            });
            
            return json;
        }
        
        function switchTab(view) {
            currentView = view;
            
            // Update tab buttons
            document.getElementById('reviewTab').classList.toggle('active', view === 'review');
            document.getElementById('jsonTab').classList.toggle('active', view === 'json');
            
            // Show/hide content
            document.getElementById('dataContent').style.display = view === 'review' ? 'block' : 'none';
            document.getElementById('jsonContent').style.display = view === 'json' ? 'block' : 'none';
            document.getElementById('fieldsSection').style.display = view === 'review' ? 'block' : 'none';
            
            // Update JSON view if switching to it
            if (view === 'json' && currentPageData) {
                document.getElementById('jsonDisplay').innerHTML = formatJsonWithConfidence(currentPageData);
            }
        }
        
        function filterFields() {
            const searchBox = document.getElementById('searchBox');
            if (!searchBox) {
                console.error('Search box not found');
                return;
            }
            
            const searchTerm = searchBox.value.toLowerCase();
            const fieldItems = document.querySelectorAll('#dataContent .field-item');
            let visibleCount = 0;
            
            console.log(`Filtering ${fieldItems.length} fields with term: "${searchTerm}"`);
            
            fieldItems.forEach(item => {
                const labelEl = item.querySelector('.field-label');
                const valueEl = item.querySelector('.field-value');
                
                if (!labelEl || !valueEl) {
                    // Skip items without proper structure (like signer headers or supporting docs)
                    return;
                }
                
                const label = labelEl.textContent.toLowerCase();
                const value = valueEl.textContent.toLowerCase();
                const matches = label.includes(searchTerm) || value.includes(searchTerm);
                
                item.style.display = matches ? 'block' : 'none';
                if (matches) visibleCount++;
            });
            
            // Update field count
            const totalFields = fieldItems.length;
            const fieldCountEl = document.getElementById('fieldCount');
            if (fieldCountEl) {
                fieldCountEl.textContent = searchTerm 
                    ? `${visibleCount} of ${totalFields} fields`
                    : `${totalFields} fields`;
            }
            
            console.log(`Showing ${visibleCount} of ${totalFields} fields`);
        }

        function zoomIn() {
            if (currentZoom < 200) {
                currentZoom += 10;
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > 50) {
                currentZoom -= 10;
                applyZoom();
            }
        }

        function applyZoom() {
            const img = document.querySelector('#viewerContent img');
            if (img) {
                img.style.transform = `scale(${currentZoom / 100}) rotate(${currentRotation}deg)`;
                img.style.transformOrigin = 'center center';
                img.style.transition = 'transform 0.3s ease';
            }
            document.getElementById('zoomLevel').textContent = `${currentZoom}%`;
        }

        function rotateImage() {
            currentRotation = (currentRotation + 90) % 360;
            applyZoom();
        }

        function toggleFullscreen() {
            const viewer = document.getElementById('viewerContent');
            if (!document.fullscreenElement) {
                viewer.requestFullscreen().catch(err => {
                    showNotification('Fullscreen not supported', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        function downloadCurrentPage() {
            const img = document.querySelector('#viewerContent img');
            if (img) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `page_${currentPageIndex + 1}.png`;
                link.click();
                showNotification('Downloading page...', 'success');
            }
        }

        // Reset zoom and rotation when changing pages
        function resetViewerTransform() {
            currentZoom = 100;
            currentRotation = 0;
            document.getElementById('zoomLevel').textContent = '100%';
        }

        // Helper function to convert technical field names to user-friendly names
        function formatFieldName(fieldPath) {
            let fieldName = fieldPath.split('.').pop();
            fieldName = fieldName.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            
            const fieldMappings = {
                'Authorized Signers': 'Authorized Signer Names',
                'Account Number': 'Account Number',
                'Business Name': 'Business Name',
                'Branch Name': 'Branch Name',
                'Associate Name': 'Associate Name',
                'Request Date': 'Request Date',
                'Mail To Branch': 'Mail to Branch',
                'Abbreviations Needed': 'Abbreviations Needed',
                'Business Name Abbreviated': 'Business Name (Abbreviated)',
                'Signer Name Abbreviated': 'Signer Name (Abbreviated)',
                'Mail To Signer': 'Mail to Authorized Signer',
                'Mail To Business': 'Mail to Business',
                'Associate Signature': 'Associate Signature',
                'Customer Signature': 'Customer Signature',
                'Date In Footer': 'Date in Footer',
                'Form Revision': 'Form Revision',
                'Form Id': 'Form ID'
            };
            
            return fieldMappings[fieldName] || fieldName;
        }

        // Changes Review Modal Functions (same as account viewer)
        async function showChangesModal() {
            try {
                const response = await fetch(`/api/document/${documentId}/changes`);
                const data = await response.json();
                
                if (!data.success) {
                    showNotification('Failed to load changes', 'error');
                    return;
                }
                
                const changes = data.changes;
                if (changes.length === 0) {
                    showNotification('No changes to review', 'info');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'changesModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
                
                let changesHTML = `
                    <div style="padding: 30px 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
                            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                üìù
                            </div>
                            <div>
                                <h2 style="font-size: 1.75em; color: white; margin: 0; font-weight: 700; letter-spacing: -0.5px;">Review Changes</h2>
                                <p style="color: rgba(255,255,255,0.9); font-size: 0.95em; margin: 4px 0 0 0;">Select which updates you want to apply</p>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 30px 35px; background: #f9fafb;">
                        <div style="margin-bottom: 25px;">
                            <label style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.15)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'">
                                <input type="checkbox" id="selectAll" onchange="toggleAllChanges(this.checked)" style="width: 20px; height: 20px; cursor: pointer; accent-color: #667eea;">
                                <span style="font-weight: 600; color: #1f2937; font-size: 1.05em;">Select All Changes (${changes.length})</span>
                            </label>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                `;
                
                changes.forEach((change, index) => {
                    const changeType = change.change_type;
                    const field = change.field;
                    const fieldDisplayName = formatFieldName(field);
                    const oldValue = change.old_value || 'N/A';
                    const newValue = change.new_value || '(empty)';
                    
                    const isAdded = changeType === 'added';
                    const accentColor = isAdded ? '#10b981' : '#f59e0b';
                    const accentBg = isAdded ? '#ecfdf5' : '#fef3c7';
                    const icon = isAdded ? '‚ûï' : '‚úèÔ∏è';
                    const badgeText = isAdded ? 'NEW' : 'UPDATED';
                    
                    changesHTML += `
                        <label style="display: flex; gap: 18px; padding: 20px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.borderColor='${accentColor}'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <input type="checkbox" class="change-checkbox" data-index="${index}" style="width: 22px; height: 22px; cursor: pointer; margin-top: 4px; accent-color: ${accentColor}; flex-shrink: 0;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                                    <div style="width: 36px; height: 36px; background: ${accentBg}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                                        ${icon}
                                    </div>
                                    <span style="font-weight: 700; color: #111827; font-size: 1.1em; letter-spacing: -0.3px;">${fieldDisplayName}</span>
                                    <span style="padding: 4px 12px; background: ${accentColor}; color: white; border-radius: 20px; font-size: 0.75em; font-weight: 700; letter-spacing: 0.5px;">${badgeText}</span>
                                </div>
                                <div style="font-size: 0.8em; color: #9ca3af; margin-bottom: 14px; font-family: 'Courier New', monospace; background: #f9fafb; padding: 6px 10px; border-radius: 6px; display: inline-block;">${field}</div>
                                ${changeType === 'updated' ? `
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                            <span style="font-size: 0.8em; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Previous Value</span>
                                            <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
                                        </div>
                                        <div style="padding: 12px 16px; background: #fef2f2; border-left: 3px solid #ef4444; color: #991b1b; border-radius: 8px; font-size: 0.95em; line-height: 1.6; word-break: break-word; font-family: system-ui, -apple-system, sans-serif;">${oldValue}</div>
                                    </div>
                                ` : ''}
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 0.8em; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">${isAdded ? 'Value' : 'New Value'}</span>
                                        <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
                                    </div>
                                    <div style="padding: 12px 16px; background: #f0fdf4; border-left: 3px solid #10b981; color: #065f46; border-radius: 8px; font-size: 0.95em; line-height: 1.6; word-break: break-word; font-family: system-ui, -apple-system, sans-serif;">${newValue}</div>
                                </div>
                            </div>
                        </label>
                    `;
                });
                
                changesHTML += `
                        </div>
                    </div>
                    <div style="padding: 25px 35px; background: white; border-top: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; border-radius: 0 0 12px 12px;">
                        <div style="color: #6b7280; font-size: 0.9em;">
                            <span style="font-weight: 600; color: #374151;">${changes.length}</span> change(s) detected
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeChangesModal()" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95em;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#9ca3af'" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db'">
                                Cancel
                            </button>
                            <button onclick="applySelectedChanges()" style="padding: 12px 28px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.95em; box-shadow: 0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                                ‚úì Apply Selected Changes
                            </button>
                        </div>
                    </div>
                `;
                
                modalContent.innerHTML = changesHTML;
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                document.getElementById('selectAll').checked = true;
                toggleAllChanges(true);
                
            } catch (error) {
                console.error('Error loading changes:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        function toggleAllChanges(checked) {
            document.querySelectorAll('.change-checkbox').forEach(cb => cb.checked = checked);
        }
        
        function closeChangesModal() {
            const modal = document.getElementById('changesModal');
            if (modal) modal.remove();
        }
        
        async function applySelectedChanges() {
            const selectedIndices = [];
            document.querySelectorAll('.change-checkbox:checked').forEach(cb => {
                selectedIndices.push(parseInt(cb.dataset.index));
            });
            
            if (selectedIndices.length === 0) {
                showNotification('Please select at least one change to apply', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/document/${documentId}/apply-changes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({selected_changes: selectedIndices})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Applied ${data.applied_count} changes successfully`, 'success');
                    closeChangesModal();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification('Failed: ' + data.message, 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        async function rejectAllChanges() {
            if (!confirm('Reject all changes? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/document/${documentId}/mark-reviewed`, {method: 'POST'});
                const data = await response.json();
                
                if (data.success) {
                    showNotification('All changes rejected', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification('Failed: ' + data.message, 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Load pages on page load
        loadPages();
    </script>
</body>
</html>
